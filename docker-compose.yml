networks:
  reader:
    ipam:
      config:
        - subnet: 172.19.0.0/16
          gateway: 172.19.0.1

services:
  mysql_init:
    image: biblemesh/shibboleth-common:1.0.0-dev
    depends_on:
      - common
    build:
      context: .
      dockerfile: Dockerfile.certs
    environment:
      - SHIBBOLETH_IDENTITY_PROVIDER_HOST=op-sp-1.test  # FIXME use env file
    volumes:
      - ./add-data-to-sql-file.sh:/data/entrypoint.sh:ro
      - ./seeds.sql:/data/seeds.sql:ro
      - mysql-init-script:/data/output:rw
    command: ["/data/entrypoint.sh"]
  mysql:
    image: bitnami/mysql:8.0.40
    depends_on:
      mysql_init:
        condition: service_completed_successfully
    restart: always
    env_file: docker-compose/mysql.env
    environment:
      # TODO remove the next line when we support the new auth plugin
      MYSQL_EXTRA_FLAGS: "--default-authentication-plugin=mysql_native_password"
    volumes:
      - mysql-db:/bitnami/mysql/data
      - ./db_structure.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - type: volume
        source: mysql-init-script
        target: /docker-entrypoint-initdb.d/02-initdata.sql
        read_only: true
        volume:
          nocopy: true
          subpath: 02-initdata.sql
    networks:
      - reader
    healthcheck:
      test: ['CMD', '/opt/bitnami/scripts/mysql/healthcheck.sh']
      interval: 15s
      timeout: 5s
      retries: 6

  reader:
    image: biblemesh/reader
    depends_on:
      mysql:
        condition: service_healthy
    build:
      context: .
      target: development
    command: ["npm", "start"]
    volumes:
      - ./app.js:/app/app.js
      - ./src:/app/src
    init: true
    env_file:
      - docker-compose/app.env
    networks:
      - reader

include:
  - git@github.com:biblemesh/ereader-callback.git#16d35c3cc24b858910a9a7a7c1bb5ef14a0aeb52
  - path: git@github.com:biblemesh/shibboleth.git#fb956493d0ebed2826fa96015093e4e0e2eedd48:.devcontainer/shibboleth/docker-compose.yml
    env_file: .env.shibboleth

volumes:
  mysql-init-script:
  mysql-db:
